---
import "../tailwind.css";
import Flag from '../assets/logo.svg';
import { Picture } from "astro:assets";
import { Code } from "astro:components";

export const prerender = false
let profileData;
// console.log("epa")
// console.log(Astro.cookies)
// console.log(Astro.request)
// console.log("Astro.response--------------------")
// console.log(Astro.response)
// console.log("Astro.request.headers--------------------")
// console.log(Astro.request.headers)
// console.log("Astro.request.cookie--------------------")
const cookieHeader = Astro.request.headers.get('cookie');
// console.log(cookieHeader, (typeof cookieHeader));
const match = cookieHeader?.match(/access_token=([^;]+)/);
console.log("match:", match? match[0] : null)
const split = match? match[0] : null
const access_token = split?.split("=")[1];

let data = null
if (Astro.cookies.has("id_user")) {
  console.log("Tiene la cookie")
  const id_user = Astro.cookies.get("id_user")?.value
  // console.log(id_user)
  
  const fetchData = async () => {
    const response = await fetch(`http://localhost:3000/api/v1/user/profile?id_user=${id_user}`, {
      method: 'GET',
      headers: {
        'x-api-version': '1',
        'Content-Type': 'application/json',
      }
    })
    profileData = await response.json();
    // console.log("profileData:", profileData)
    return profileData
  }

  data = await fetchData()
  console.log("data:", data)
}

// onMount(async () => {
//   const response = await fetch('http://localhost:3000/v1/auth/profile/');
//   profileData = await response.json();
//   console.log("----------------------")
//   console.log(profileData)
// });
---

<head>
  <meta charset="UTF-8" />
</head>
<body class="flex flex-col h-screen bg-[#162332] font-lexend m-0">
  <header class="flex justify-between items-center m-0 border-black bg-[#23344b] text-white py-[10px] px-6">
      <a href="/" target="_blank">
        <Picture src={Flag} alt="test" class="w-10 h-10" >
      </a>
      <!-- w-12 mr-28 -->
      <div class="flex justify-between items-center w-44">
        <div class="flex justify-between items-center w-14">
          <a href="https://www.linkedin.com/in/ariel-britez-diaz-technical/" target="_blank">
            <span class="icon-[mdi--linkedin] bg-white w-5 h-5 hover:bg-neutral-400"></span>
          </a>
          <a href="https://github.com/ArielBritezDiaz" target="_blank">
            <span class="icon-[bi--github] bg-white w-4 h-4 hover:bg-neutral-400"></span>
          </a>
        </div>
        <div class="flex flex-col border-l-[1px] px-4">
          <span>Countries</span>
          <span>Sundries</span>
        </div>
      </div>
  </header>
  <main class="flex flex-row items-center justify-center h-screen">
      {
        data && access_token ? (
        <div class="bg-white rounded p-7 w-1/3 h-3/4 mx-20 relative">
          <p class="text-6xl text-[#23344B] py-5 m-0">Profile</p>

          <div class="flex alig-items align-items py-8 text-3xl">
            <span class="text-black underline pr-3">Name: </span><span class="text-[#23344b]">{data.name}</span>
          </div>
          <div class="flex alig-items align-items py-8 text-3xl">
            <span class="text-black underline pr-3">E-mail: </span><span class="text-[#23344b]">{data.email}</span>
          </div>
          <div class="flex alig-items align-items py-8 text-3xl">
            <span class="text-black underline pr-3">Created At: </span><span class="text-[#23344b]">{data.created_at}</span>
          </div>

          <a href="/docs/introduction/get-api-key/" class="absolute bottom-0 left-0 ml-5 mb-12 w-1/3 p-5 text-3xl text-white bg-[#23344b] hover:bg-[#2f4564] rounded no-underline">
            Back to Docs
          </a>
        </div>
        <div class="bg-white rounded p-7 w-1/3 h-3/4 mx-20">
          <p class="text-6xl text-[#23344B] no-underline py-5 m-0">Token</p>

          <div class="copy-text flex align-items-center justify-center py-5">
            <input type="text" class="text text-2xl w-full p-4 text-white bg-[#23344b] rounded overflow-scroll hover:cursor-default focus:outline-none" value={access_token} readonly />
            <button class="bg-[#23344b] text-[#60b4fd] mx-1 p-3.5 rounded transition-all delay-60 hover:bg-[#60b4fd] hover:text-[#23344b] hover:cursor-pointer">
              <span class="icon-[solar--copy-bold-duotone] w-8 h-8"></span>
            </button>
          </div>
        </div>
      ) : (
          <div>
            <span>No profile data. For auto login, <a href="http://localhost:3000/v1/auth/google/login">click here <span class="icon-[flat-color-icons--google] text-xl p-0 m-0"></span></a></span>
          </div>
        )
      }
  </main>
</body>

<script>
  let copyText = document.querySelector('.copy-text');
  copyText?.querySelector('button')?.addEventListener('click', () => {
    let input = copyText.querySelector('input.text');
    input?.select();
    document.execCommand('copy');
    copyText.classList.add('copied');
    window?.getSelection()?.removeAllRanges();
    setTimeout(() => {
      copyText.classList.remove('copied');
    }, 1000);
  });
</script>

<!-- focus o active para el input -->